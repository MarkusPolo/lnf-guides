---
interface Props {
  id?: string;          // z.B. "jKQem4Z6ioQ"
  url?: string;         // oder komplette YouTube-URL
  title?: string;
  aspect?: string;      // CSS aspect-ratio, default "16/9"
}

function parseYouTubeId(u: string): string | null {
  try {
    if (!u) return null;
    const Y = new URL(u, "https://x.invalid");
    const host = Y.hostname.replace(/^www\./, "");
    if (host === "youtu.be") return Y.pathname.slice(1) || null;
    const v = Y.searchParams.get("v");
    if (v) return v;
    const m1 = Y.pathname.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
    if (m1) return m1[1];
    const m2 = Y.pathname.match(/\/shorts\/([A-Za-z0-9_-]{6,})/);
    if (m2) return m2[1];
    return null;
  } catch {
    if (/^[A-Za-z0-9_-]{6,}$/.test(u)) return u;
    return null;
  }
}

const { id, url, title = 'YouTube video', aspect = '16/9' } = Astro.props as Props;
const videoId = id ?? parseYouTubeId(url ?? "") ?? "";
const src = videoId ? `https://www.youtube-nocookie.com/embed/${videoId}?rel=0` : "";
---

<div
  id={`yt-wrap-${videoId || 'unknown'}`}
  class="rounded-card border border-border/60 bg-[#0f1422] shadow-soft overflow-hidden"
  data-yt-id={videoId}
  data-yt-title={title}
  data-yt-src={src}
  data-yt-aspect={aspect}
>
  <div class="relative w-full" style={`aspect-ratio:${aspect}`}>
    <!-- Placeholder -->
    <div class="absolute inset-0 flex items-center justify-center" data-yt-ph>
      <div class="text-center px-4">
        <p class="mb-3 text-sm text-text2">
          YouTube placeholder (blocked until you allow external embeds)
        </p>
        <div class="flex items-center justify-center gap-3">
          <button class="btn btn-outline" data-yt-play>Play video</button>
          <!-- Öffnet die CMP-UI, damit Nutzer Embeds erlauben kann -->
          <button class="btn btn-primary" data-privacy-open>Always allow embeds</button>
        </div>
        <div class="mt-2">
          <button class="underline hover:text-text text-xs" data-privacy-open>Manage privacy settings</button>
        </div>
      </div>
    </div>
  </div>

  <p class="text-center text-xs text-text2 py-2">
    This embed loads content from YouTube.
  </p>
</div>

<script is:inline>
  (function () {
    const root =
      document.currentScript?.previousElementSibling?.closest('[data-yt-id]') ||
      document.querySelector('[data-yt-id]');
    if (!root) return;

    const ytTitle   = root.getAttribute('data-yt-title') || 'YouTube video';
    const ytSrc     = root.getAttribute('data-yt-src') || '';
    const ph        = root.querySelector('[data-yt-ph]');
    const btnPlay   = root.querySelector('[data-yt-play]');
    const frameHost = root.querySelector('.relative.w-full');

    function hasExternalConsent() {
      try {
        // @ts-ignore
        return !!(window.lnfConsent && window.lnfConsent.allowed && window.lnfConsent.allowed('external'));
      } catch { return false; }
    }

    function mountIframe() {
      if (!frameHost || !ytSrc) return;
      if (frameHost.querySelector('iframe')) return;
      const iframe = document.createElement('iframe');
      iframe.src = ytSrc;
      iframe.title = ytTitle;
      iframe.width = '560';
      iframe.height = '315';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
      iframe.referrerPolicy = 'strict-origin-when-cross-origin';
      iframe.allowFullscreen = true;
      iframe.className = 'absolute inset-0 w-full h-full';
      frameHost.appendChild(iframe);
      ph?.remove();
    }

    // Initial
    if (hasExternalConsent()) mountIframe();

    // Auf Consent-Änderungen reagieren
    const onChange = (e) => {
      const d = e?.detail;
      if (d && d.external) mountIframe();
    };
    window.addEventListener('consent:changed', onChange, { passive: true });
    window.addEventListener('consent:updated', onChange, { passive: true });

    // „Play video“: Bei vorhandener Einwilligung sofort laden, sonst CMP öffnen
    btnPlay?.addEventListener('click', (ev) => {
      ev.preventDefault();
      if (hasExternalConsent()) mountIframe();
      else if (typeof window.openPrivacy === 'function') window.openPrivacy();
    });
  })();
</script>
