---
interface Props {
  name: string;
  height?: number;
  provider?: 'house' | 'adsense';
  adsClient?: string;
  adSlot?: string;
  class?: string;
}

const {
  name,
  height = 250,
  provider = 'house',
  adsClient = '',
  adSlot = '',
  class: cls = '',
} = Astro.props as Props;

const wrapId = `adslot-${name.replace(/\W+/g, '-')}`;
---

<div
  id={wrapId}
  class={`rounded-card border border-border/60 bg-[#0f1422] shadow-soft overflow-hidden ${cls}`}
  style={`min-height:${height}px`}
  data-provider={provider}
  data-ads-client={adsClient}
  data-ad-slot={adSlot}
  data-height={String(height)}
  data-state="init"
>
  <div class="h-full flex items-center justify-between gap-3 p-4">
    <div class="text-left">
      <div class="text-sm text-text2 mb-1">Support LNF Guides</div>
      <div class="text-base text-text">Loading…</div>
      <button class="underline mt-1" data-privacy-open>Privacy settings</button>
    </div>
    <div class="hidden md:block text-right">
      <div class="inline-block rounded-card border border-border/60 bg-border/20 px-3 py-1 text-[11px]">
        Ads • {name}
      </div>
    </div>
  </div>
</div>

<script is:inline data-for={wrapId}>
(function(){
  const scriptEl = document.currentScript;
  if (!scriptEl) return;

  let root = scriptEl.previousElementSibling;
  if (!root || !(root instanceof HTMLElement)) {
    const id = scriptEl.getAttribute('data-for');
    if (id) root = document.getElementById(id);
  }
  if (!root || !(root instanceof HTMLElement)) return;

  const provider   = root.getAttribute('data-provider') || 'house';
  const adsClient  = root.getAttribute('data-ads-client') || '';
  const adSlot     = root.getAttribute('data-ad-slot') || '';
  const height     = Number(root.getAttribute('data-height') || '250');

  function setState(s){ root.setAttribute('data-state', s); }
  function clear(el){ while (el.firstChild) el.removeChild(el.firstChild); }

  function badge(allowed){
    const tone = allowed ? 'border-[#68D391]/50 bg-[#68D391]/15' : 'border-border/60 bg-border/20';
    const label = allowed ? 'Allowed' : 'Disallowed';
    return `<div class="inline-block rounded-card border ${tone} px-3 py-1 text-[11px]">${label} • ${root.id || 'slot'}</div>`;
  }

  function renderInfo(allowed, statusText, personalized) {
    clear(root);
    const box = document.createElement('div');
    box.className = 'h-full flex items-center justify-between gap-3 p-4';
    box.innerHTML = `
      <div class="text-left">
        <div class="text-sm text-text2 mb-1">Support LNF Guides</div>
        <div class="text-base text-text">${statusText}</div>
        <div class="text-xs text-text2 mt-1">Debug: Personalized: <strong>${personalized ? 'On' : 'Off'}</strong></div>
        <button class="underline mt-1" data-privacy-open>Privacy settings</button>
      </div>
      <div class="hidden md:block text-right">${badge(allowed)}</div>
    `;
    root.appendChild(box);
  }

  function ensureAdSenseScript(client){
    const id = 'adsbygoogle-js';
    if (document.getElementById(id)) return true;
    try{
      const s = document.createElement('script');
      s.id = id;
      s.async = true;
      s.crossOrigin = 'anonymous';
      s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=' + encodeURIComponent(client);
      s.setAttribute('data-ad-client', client);
      document.head.appendChild(s);
      return true;
    }catch{ return false; }
  }

  function alreadyMounted(){
    const ins = root.querySelector('ins.adsbygoogle');
    if (!ins) return false;
    if (ins.getAttribute('data-ad-status')) return true;
    if (ins.getAttribute('data-adsbygoogle-pushed') === 'true') return true;
    return false;
  }

  function mountAdSenseAndReport(consent){
    const { adsPersonalized } = consent;

    if (!adsClient || !adSlot){
      setState('allowed-config-missing');
      renderInfo(true, 'Allowed — missing configuration (client/slot).', adsPersonalized);
      return;
    }
    const ok = ensureAdSenseScript(adsClient);
    if (!ok){
      setState('allowed-script-blocked');
      renderInfo(true, 'Allowed — script blocked (CSP/adblock).', adsPersonalized);
      return;
    }

    let ins = root.querySelector('ins.adsbygoogle');
    if (!ins){
      clear(root);
      ins = document.createElement('ins');
      ins.className = 'adsbygoogle';
      ins.style.cssText = `display:block; min-height:${height}px;`;
      ins.setAttribute('data-ad-client', adsClient);
      ins.setAttribute('data-ad-slot', adSlot);
      ins.setAttribute('data-full-width-responsive', 'true');
      root.appendChild(ins);
    }

    if (!alreadyMounted()){
      try{
        (window.adsbygoogle = window.adsbygoogle || []).push({});
        ins.setAttribute('data-adsbygoogle-pushed','true');
        setState('allowed-requested');
        setTimeout(() => {
          const hasIframe = !!ins.querySelector('iframe');
          const h = ins.offsetHeight;
          if (hasIframe || h >= 20){
            setState('allowed-rendered');
          } else {
            setState('allowed-no-fill-or-blocked');
          }
        }, 1200);
      }catch(e){
        setState('allowed-init-failed');
        renderInfo(true, 'Allowed — initialization failed (adblock/CSP).', adsPersonalized);
      }
    }
  }

  function readConsent(){
    try {
      // @ts-ignore
      const s = window.lnfConsent && typeof window.lnfConsent.get === 'function' ? window.lnfConsent.get() : null;
      return s || { analytics:false, ads:false, adsPersonalized:false, external:false };
    } catch { return { analytics:false, ads:false, adsPersonalized:false, external:false }; }
  }

  function apply(){
    if (provider !== 'adsense'){
      setState('provider-house');
      renderInfo(false, 'Provider is "house" (no ad requested).', false);
      return;
    }
    const consent = readConsent();
    // Immer mounten → Google entscheidet, ob PA / NPA / LTD
    mountAdSenseAndReport(consent);
  }

  apply();
  window.addEventListener('consent:changed', apply, { passive: true });
  window.addEventListener('consent:updated', apply, { passive: true });
})();
</script>
