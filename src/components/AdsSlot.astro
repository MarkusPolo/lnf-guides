---
/**
 * DSGVO-freundlicher Ad-Slot mit Personalisierung:
 * - Lädt AdSense nur wenn consent.ads === true
 * - Personalisierung NUR wenn consent.adsPersonalized === true
 *   -> (window.adsbygoogle.requestNonPersonalizedAds = 0/1)
 * - Ohne Consent: House-Ad
 *
 * Props:
 *  - name: string
 *  - height?: number = 250
 *  - provider?: 'house' | 'adsense' = 'house'
 *  - adsClient?: string   (erforderlich bei adsense)
 *  - adSlot?: string      (erforderlich bei adsense)
 *  - class?: string
 */

interface Props {
  name: string;
  height?: number;
  provider?: 'house' | 'adsense';
  adsClient?: string;
  adSlot?: string;
  class?: string;
}

const {
  name,
  height = 250,
  provider = 'house',
  adsClient = '',
  adSlot = '',
  class: cls = '',
} = Astro.props as Props;

const wrapId = `adslot-${name.replace(/\W+/g, '-')}`;
---

<div
  id={wrapId}
  class={`rounded-card border border-border/60 bg-[#0f1422] shadow-soft overflow-hidden ${cls}`}
  style={`min-height:${height}px`}
  data-provider={provider}
  data-ads-client={adsClient}
  data-ad-slot={adSlot}
  data-height={String(height)}
>
  <div class="h-full flex items-center justify-between gap-3 p-4">
    <div class="text-left">
      <div class="text-sm text-text2 mb-1">Support LNF Guides</div>
      <div class="text-base text-text">Ads are disabled until you allow them.</div>
      <button class="underline mt-1" data-privacy-open>Privacy settings</button>
    </div>
    <div class="hidden md:block text-right">
      <div class="inline-block rounded-card border border-[#68D391]/50 bg-[#68D391]/15 px-3 py-1 text-[11px]">
        House • {name}
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const root =
      document.currentScript?.previousElementSibling ||
      document.querySelector('#{wrapId}'.replace('#','')) || // harmless
      document.querySelector('[data-provider]');
    if (!root) return;

    const provider   = root.getAttribute('data-provider') || 'house';
    const adsClient  = root.getAttribute('data-ads-client') || '';
    const adSlot     = root.getAttribute('data-ad-slot') || '';
    const height     = Number(root.getAttribute('data-height') || '250');

    // ---- Consent helpers ----
    const LS_KEYS = ['lnf-consent-v1','lnf-consent'];
    function readLS() {
      for (const k of LS_KEYS) {
        try { const raw = localStorage.getItem(k); if (raw) return JSON.parse(raw); } catch {}
      }
      return null;
    }
    function getDecisions() {
      try {
        const via = window.consent?.get?.();
        if (via && (via.ads !== undefined)) return via;
        if (via?.decisions) return via.decisions;
      } catch {}
      const d = readLS()?.decisions || {};
      return {
        analytics: !!d.analytics,
        external: !!d.external,
        ads: !!d.ads,
        adsPersonalized: !!d.adsPersonalized
      };
    }

    function clearChildren(el){ while (el.firstChild) el.removeChild(el.firstChild); }

    function renderHouse() {
      clearChildren(root);
      const box = document.createElement('div');
      box.className = 'h-full flex items-center justify-between gap-3 p-4';
      box.innerHTML = `
        <div class="text-left">
          <div class="text-sm text-text2 mb-1">Support LNF Guides</div>
          <div class="text-base text-text">Ads are disabled until you allow them.</div>
          <button class="underline mt-1" data-privacy-open>Privacy settings</button>
        </div>
        <div class="hidden md:block text-right">
          <div class="inline-block rounded-card border border-[#68D391]/50 bg-[#68D391]/15 px-3 py-1 text-[11px]">House • ${root.id || 'slot'}</div>
        </div>
      `;
      root.appendChild(box);
    }

    function ensureAdSenseScript(client) {
      const id = 'adsbygoogle-js';
      if (document.getElementById(id)) return;
      const s = document.createElement('script');
      s.id = id;
      s.async = true;
      s.crossOrigin = 'anonymous';
      s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=' + encodeURIComponent(client);
      document.head.appendChild(s);
    }

    function mountAdSense({ personalized }){
      if (!adsClient || !adSlot) { renderHouse(); return; }
      ensureAdSenseScript(adsClient);

      clearChildren(root);

      // Personalisierung steuern (NPA: 1 = non-personalized, 0 = personalized)
      try {
        const npa = personalized ? 0 : 1;
        (window.adsbygoogle = window.adsbygoogle || []).requestNonPersonalizedAds = npa;
      } catch {}

      const ins = document.createElement('ins');
      ins.className = 'adsbygoogle';
      ins.style.cssText = `display:block; min-height:${height}px;`;
      ins.setAttribute('data-ad-client', adsClient);
      ins.setAttribute('data-ad-slot', adSlot);
      ins.setAttribute('data-full-width-responsive', 'true');

      root.appendChild(ins);

      try { (window.adsbygoogle = window.adsbygoogle || []).push({}); }
      catch { renderHouse(); }
    }

    function apply(){
      const d = getDecisions();
      if (!d.ads) { renderHouse(); return; }
      if (provider === 'adsense') {
        mountAdSense({ personalized: !!d.adsPersonalized });
      } else {
        renderHouse();
      }
    }

    apply();
    window.addEventListener('consent:changed', apply);
    window.addEventListener('consent:updated', apply);
  })();
</script>
