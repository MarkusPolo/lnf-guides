---
import "../styles/global.css";
import ConsentBanner from "../components/ConsentBanner.astro";
import DebugConsent from "../components/DebugConsent.astro";

const { title, description, canonical, ogImage, type = 'website', category } = Astro.props as any;

const site = Astro.site?.origin ?? 'https://lnf-guides.com';
const url = canonical ?? new URL(Astro.url.pathname, site);
const siteUrl = String(Astro.site ?? site);

const ogFallbackByCategory: Record<string,string> = {
  dragons: '/images/og/dragons.png',
  beginners: '/images/og/beginners.png',
};
const finalOg = ogImage || ogFallbackByCategory[category] || '/images/og/default.png';
const PLAUSIBLE_DOMAIN = 'lnf-guides.com';
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="canonical" href={String(url)} />

    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={String(canonical)} />

    <!-- OG / Twitter -->
    <meta property="og:type" content={type} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={String(canonical)} />
    <meta property="og:image" content={finalOg} />
    <meta property="og:site_name" content="LNF Guides" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={finalOg} />

    <link rel="icon" href="/images/logo.svg" type="image/svg+xml" />

    <!-- JSON-LD: WebSite -->
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": siteUrl,
        "name": "LNF Guides",
        "potentialAction": {
          "@type": "SearchAction",
          "target": `${siteUrl}/search?q={query}`,
          "query-input": "required name=query"
        }
      })}
    </script>

    <!-- JSON-LD: Organization -->
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "LNF Guides",
        "url": siteUrl,
        "logo": `${siteUrl}/images/logo.svg`,
        "sameAs": ["https://github.com/lnf-guides"]
      })}
    </script>

    <!-- Plausible (nur geladen, wenn consent.analytics true ist; Gate im Body-Script) -->
    <script id="plausible-script" defer data-domain={PLAUSIBLE_DOMAIN} src="https://plausible.io/js/script.js"></script>
  </head>
  <body class="font-sans">
    <a href="#content" class="sr-only focus:not-sr-only focus:fixed focus:left-4 focus:top-4 focus:bg-surface focus:px-3 focus:py-2 focus:rounded">Skip to content</a>

    <header class="sticky top-0 z-[1000] isolate border-b border-border/60 bg-bg backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-4">
        <a href="/" class="flex items-center gap-2">
          <img src="/images/logo.svg" alt="LNF Guides" class="h-7 w-7" />
          <span class="text-lg font-extrabold tracking-tight">LNF Guides</span>
        </a>

        <div class="flex-1 max-w-xl mx-auto hidden md:block">
          <button id="open-search" class="w-full text-left border border-border/60 rounded-full px-4 py-2 text-text2 hover:bg-surface" aria-label="Open search (Cmd/Ctrl+K)">
            Press ⌘/Ctrl K to search…
          </button>
        </div>

        <nav class="flex items-center gap-4 text-sm">
          <a href="/guides/" class="hover:underline">Guides</a>
          <a href="/news/" class="hover:underline">News</a>
          <a href="/updates/" class="hover:underline">Updates</a>
          <a href="/about/" class="hover:underline">About</a>
          <button id="btn-privacy" class="btn btn-outline">Manage privacy</button>
          <a href="/contact/" class="btn btn-primary">Subscribe</a>
        </nav>
      </div>
    </header>

    <slot name="search" />
    <main id="content"><slot /></main>

    <footer class="mt-16 border-t border-border/60">
      <div class="mx-auto max-w-7xl px-4 py-12 grid gap-8 md:grid-cols-4 text-sm">
        <section>
          <h3 class="font-semibold mb-3">Site</h3>
          <ul class="space-y-2">
            <li><a href="/">Home</a></li>
            <li><a href="/guides/">Guides</a></li>
            <li><a href="/news/">News</a></li>
            <li><a href="/updates/">Updates</a></li>
          </ul>
        </section>
        <section>
          <h3 class="font-semibold mb-3">Legal</h3>
          <ul class="space-y-2">
            <li><a href="/privacy/">Privacy</a></li>
            <li><a href="/contact/">Contact</a></li>
          </ul>
        </section>
        <section class="md:col-span-2">
          <h3 class="font-semibold mb-3">Controls</h3>
          <button id="btn-privacy-footer" class="btn btn-outline">Manage privacy</button>
        </section>
      </div>
      <div class="mx-auto max-w-7xl px-4 pb-10 text-xs text-text2">
        Unofficial fan site. Not affiliated with Hello Games.
      </div>
    </footer>

    <!-- Search trigger -->
    <script>
      document.getElementById('open-search')?.addEventListener('click', () =>
        window.dispatchEvent(new KeyboardEvent('keydown', { key: 'k', ctrlKey: true }))
      );
    </script>

    <!-- Consent: open from header/footer -->
    <script>
      document.getElementById('btn-privacy')?.addEventListener('click', () => {
        window.dispatchEvent(new CustomEvent('consent:open'));
      });
      document.getElementById('btn-privacy-footer')?.addEventListener('click', () => {
        window.dispatchEvent(new CustomEvent('consent:open'));
      });
    </script>

    <!-- Analytics gate: disable Plausible unless analytics consent -->
    <script>
      (function(){
        var s = document.getElementById('plausible-script');
        function apply(){
          try {
            var c = window.consent?.get?.() || {};
            var ok = c?.decisions ? !!c.decisions.analytics : !!c.analytics;
            if (!ok && s) {
              s.remove(); // prevent load
            }
          } catch(e){}
        }
        apply();
        window.addEventListener('consent:changed', apply);
      })();
    </script>

    <ConsentBanner />
    <DebugConsent />
  </body>
</html>
