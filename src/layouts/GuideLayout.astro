---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import TOC from '../components/TOC.astro';
import SearchOverlay from '../components/SearchOverlay.astro';
import AdsSlot from '../components/AdsSlot.astro';
import CommentsGiscus from '../components/CommentsGiscus.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import PrevNext from '../components/PrevNext.astro';

import { buildBreadcrumbLD, buildArticleLD, attachFAQPartsToArticle, type FAQSection } from '../lib/schema';

const { frontmatter, headings, currentSlug } = Astro.props as {
  frontmatter: any;
  headings: { depth: number; slug: string; text: string }[];
  currentSlug: string;
};

const canonical = new URL(Astro.url.pathname, Astro.site).toString();
const pubISO = new Date(frontmatter.pubDate).toISOString();
const updISO = frontmatter.updatedDate ? new Date(frontmatter.updatedDate).toISOString() : undefined;

const breadcrumbLD = buildBreadcrumbLD([
  { name: 'Guides', url: new URL('/guides/', Astro.site).toString() },
  { name: frontmatter.category, url: new URL(`/guides/${frontmatter.category}/`, Astro.site).toString() },
  { name: frontmatter.title, url: canonical },
]);

// Article/BlogPosting/NewsArticle o.ä.
const baseArticleLD = buildArticleLD({
  type: frontmatter?.schema?.type || 'Article',
  headline: frontmatter.title,
  description: frontmatter.description,
  datePublished: pubISO,
  dateModified: updISO,
  image: frontmatter.cover ? [frontmatter.cover] : undefined,
  canonical,
});

// FAQ-Sektionen aus Frontmatter (oder leere Liste)
const faqSections = (frontmatter.faqSections || []) as FAQSection[];
const { article: articleLD, faqPages } = attachFAQPartsToArticle(baseArticleLD, faqSections, canonical);

// Falls du künftig weitere Schemas sammeln willst (HowTo, VideoObject, Product ...)
const extraSchemas = frontmatter?.schema?.extra || []; // Array beliebiger JSON-LD Objekte
---

<BaseLayout title={frontmatter.title} description={frontmatter.description} canonical={canonical} ogImage={frontmatter.cover} category={frontmatter.category}>
  <Fragment slot="search"><SearchOverlay /></Fragment>

  <div class="mx-auto max-w-7xl container-px mt-8 grid gap-8 lg:grid-cols-[1fr_minmax(720px,760px)_1fr]">
    <div class="hidden lg:block min-w-0"><TOC headings={headings} /></div>

    <article class="prose prose-invert max-w-[760px] w-full">
      <Breadcrumbs items={[
        {name:'Guides', href:'/guides/'},
        {name:frontmatter.category, href:`/guides/${frontmatter.category}/`},
        {name:frontmatter.title}
      ]} />
      <h1>{frontmatter.title}</h1>
      <p class="text-sm text-text2">
        <time datetime={pubISO}>{new Date(frontmatter.pubDate).toLocaleDateString('en-US')}</time>
        {frontmatter.updatedDate && <span> • Updated <time datetime={updISO}>{new Date(frontmatter.updatedDate).toLocaleDateString('en-US')}</time></span>}
        {frontmatter.readingTime && <span> • {frontmatter.readingTime} min read</span>}
      </p>

      {frontmatter.cover && (
        <img src={frontmatter.cover} alt={frontmatter.title} loading="lazy" decoding="async" class="w-full aspect-[16/9] object-cover rounded-card shadow-soft border border-border/60" />
      )}

      <div class="ad-box aspect-video mt-4">
        <AdsSlot name="article-top" provider="adsense" adsClient="ca-pub-6618488631609364" adSlot="1234567890" />
      </div>

      <slot />

      <div class="ad-box aspect-video mt-8">
        <AdsSlot name="SidebarTop" provider="adsense" adsClient="ca-pub-6618488631609364" adSlot="1234567890" />
      </div>

      <PrevNext currentSlug={currentSlug} category={frontmatter.category} />
      <RelatedPosts currentSlug={currentSlug} category={frontmatter.category} tags={frontmatter.tags} />
    </article>

    <div class="hidden lg:block"></div>

    <div class="lg:col-start-2 lg:col-end-3">
      <CommentsGiscus
        repo="MarkusPolo/lnf-guides"
        repoId="R_kgDOPnP3Sw"
        category="General"
        categoryId="DIC_kwDOPnP3S84Cu0C0"
        mapping="pathname"
        lang="en"
        theme="preferred_color_scheme"
      />
    </div>
  </div>

  <!-- JSON-LD: ein Script pro Objekt -->
  <script
    type="application/ld+json"
    is:inline
    set:html={JSON.stringify(articleLD)}
  />
  <script
    type="application/ld+json"
    is:inline
    set:html={JSON.stringify(breadcrumbLD)}
  />
  {faqPages.map((f) => (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(f)}
    />
  ))}
  {Array.isArray(extraSchemas) && extraSchemas.map((obj: any) => (
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(obj)}
    />
  ))}
</BaseLayout>
