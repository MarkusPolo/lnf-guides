---
import BaseLayout from './BaseLayout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import TOC from '../components/TOC.astro';
import SearchOverlay from '../components/SearchOverlay.astro';
import AdsSlot from '../components/AdsSlot.astro';
import CommentsGiscus from '../components/CommentsGiscus.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import PrevNext from '../components/PrevNext.astro';

const { frontmatter, headings, currentSlug } = Astro.props as {
  frontmatter: any;
  headings: { depth: number; slug: string; text: string }[];
  currentSlug: string;
};

const canonical = new URL(Astro.url.pathname, Astro.site);
const pubISO = new Date(frontmatter.pubDate).toISOString();
const updISO = frontmatter.updatedDate ? new Date(frontmatter.updatedDate).toISOString() : undefined;

const breadcrumbLD = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type':'ListItem', position:1, name:'Guides', item:new URL('/guides/', Astro.site).toString() },
    { '@type':'ListItem', position:2, name:frontmatter.category, item:new URL(`/guides/${frontmatter.category}/`, Astro.site).toString() },
    { '@type':'ListItem', position:3, name:frontmatter.title, item:new URL(Astro.url.pathname, Astro.site).toString() }
  ]
};

const articleLD = {
  '@context': 'https://schema.org',
  '@type': frontmatter?.schema?.type || 'Article',
  headline: frontmatter.title,
  description: frontmatter.description,
  datePublished: pubISO,
  ...(updISO ? { dateModified: updISO } : {}),
  image: frontmatter.cover ? [frontmatter.cover] : undefined,
  mainEntityOfPage: String(canonical)
};

if (frontmatter?.schema?.type === 'FAQPage' && frontmatter?.schema?.faq?.length) {
  Object.assign(articleLD, {
    '@type': 'FAQPage',
    mainEntity: frontmatter.schema.faq.map((qa: any) => ({
      '@type': 'Question',
      name: qa.q,
      acceptedAnswer: { '@type': 'Answer', text: qa.a }
    }))
  });
}
---

<BaseLayout title={frontmatter.title} description={frontmatter.description} canonical={canonical} ogImage={frontmatter.cover} category={frontmatter.category}>
  <Fragment slot="search"><SearchOverlay /></Fragment>

  <!-- Mobile-first container with safe gutters; grid collapses on mobile -->
  <div class="mx-auto max-w-7xl container-px mt-8 grid gap-8 lg:grid-cols-[1fr_minmax(720px,760px)_1fr]">
    <div class="hidden lg:block min-w-0"><TOC headings={headings} /></div>

    <article class="prose prose-invert max-w-[760px] w-full">
      <Breadcrumbs items={[{name:'Guides', href:'/guides/'},{name:frontmatter.category, href:`/guides/${frontmatter.category}/`},{name:frontmatter.title}]} />
      <h1>{frontmatter.title}</h1>
      <p class="text-sm text-text2">
        <time datetime={pubISO}>{new Date(frontmatter.pubDate).toLocaleDateString('en-US')}</time>
        {frontmatter.updatedDate && <span> • Updated <time datetime={updISO}>{new Date(frontmatter.updatedDate).toLocaleDateString('en-US')}</time></span>}
        {frontmatter.readingTime && <span> • {frontmatter.readingTime} min read</span>}
      </p>

      {frontmatter.cover && (
        <img src={frontmatter.cover} alt={frontmatter.title} loading="lazy" decoding="async" class="w-full aspect-[16/9] object-cover rounded-card shadow-soft border border-border/60" />
      )}

      <!-- Ad nach Hero: stabil 16:9 auf Mobile -->
      <div class="ad-box aspect-video mt-4">
        <AdsSlot name="article-top" provider="adsense" adsClient="ca-pub-6618488631609364" adSlot="1234567890" />
      </div>

      <slot />

      <!-- Ad am Artikelende -->
      <div class="ad-box aspect-video mt-8">
        <AdsSlot name="SidebarTop" provider="adsense" adsClient="ca-pub-6618488631609364" adSlot="1234567890" />
      </div>

      <PrevNext currentSlug={currentSlug} category={frontmatter.category} />
      <RelatedPosts currentSlug={currentSlug} category={frontmatter.category} tags={frontmatter.tags} />
    </article>

    <div class="hidden lg:block"></div>

    <div class="lg:col-start-2 lg:col-end-3">
      <CommentsGiscus
        repo="MarkusPolo/lnf-guides"
        repoId="R_kgDOPnP3Sw"
        category="General"
        categoryId="DIC_kwDOPnP3S84Cu0C0"
        mapping="pathname"
        lang="en"
        theme="preferred_color_scheme"
      />
    </div>
  </div>

    <!-- … dein bestehendes Markup … -->

  <style is:global>
    /* Tables innerhalb von Artikel-Content */
    article.prose :where(table) {
      display: block;               /* erlaubt overflow-x */
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow-x: auto;             /* mobile scroll */
      -webkit-overflow-scrolling: touch;
      margin: 1.25rem 0;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 1px 0 rgba(0,0,0,.08);
    }
    /* Light-Mode-Anpassung */
    .prose:not(.prose-invert) :where(table) {
      border-color: rgba(0,0,0,.12);
      box-shadow: inset 0 1px 0 rgba(0,0,0,.04);
    }

    article.prose :where(caption) {
      caption-side: bottom;
      text-align: center;
      font-size: .875rem;
      padding-top: .5rem;
      color: rgba(255,255,255,.65);
    }
    .prose:not(.prose-invert) :where(caption) { color: rgba(0,0,0,.6); }

    /* Header: sticky + Trennlinie */
    article.prose :where(thead th) {
      position: sticky;
      top: 0;
      z-index: 1;
      text-align: center;
      font-weight: 600;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.16);
      backdrop-filter: saturate(1.2) blur(2px);
    }
    .prose:not(.prose-invert) :where(thead th) {
      background: rgba(0,0,0,.03);
      border-bottom-color: rgba(0,0,0,.12);
    }

    /* Zellen: Padding, vertikale Ausrichtung, vertikale Trennlinien */
    article.prose :where(th, td) {
      padding: .75rem .875rem;
      vertical-align: top;
      border-right: 1px solid rgba(255,255,255,.08);
      white-space: normal;
    }
    .prose:not(.prose-invert) :where(th, td) { border-right-color: rgba(0,0,0,.08); }
    article.prose :where(tr > *:last-child) { border-right: 0; }

    /* Reihen-Trennung + Zebra */
    article.prose :where(tbody tr) {
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .prose:not(.prose-invert) :where(tbody tr) { border-bottom-color: rgba(0,0,0,.08); }
    article.prose :where(tbody tr:nth-child(odd) td) { background: rgba(255,255,255,.02); }
    .prose:not(.prose-invert) :where(tbody tr:nth-child(odd) td) { background: rgba(0,0,0,.02); }

    /* Default-Ausrichtung & Respekt für Markdown-Alignments */
    article.prose :where(th) { text-align: center; }
    article.prose :where(td) { text-align: left; }
    article.prose :where(th[align="left"], td[align="left"])   { text-align: left; }
    article.prose :where(th[align="center"], td[align="center"]){ text-align: center; }
    article.prose :where(th[align="right"], td[align="right"]) { text-align: right; }

    /* Zahlenspalten (optional per Attribut) */
    article.prose :where(td[data-type="num"], th[data-type="num"]) { text-align: right; font-variant-numeric: tabular-nums; }

    /* Code in Tabellenzellen nicht sprengen lassen */
    article.prose :where(td code) { white-space: pre-wrap; word-break: break-word; }
  </style>

  <script type="application/ld+json">{JSON.stringify(articleLD)}</script>
  <script type="application/ld+json">{JSON.stringify(breadcrumbLD)}</script>
</BaseLayout>
