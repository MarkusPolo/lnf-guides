---
import BaseLayout from "../layouts/BaseLayout.astro";
import LNFMap from "../components/LNFMap";
import { LNF_MAP } from "../data/lnf-map.data";

const updated = new Date(LNF_MAP.lastUpdatedISO).toLocaleDateString("en-GB", {
  year: "numeric", month: "short", day: "numeric"
});

const title = `Light No Fire Interactive Map – Pre-Release (Updated ${updated})`;
const description = "Speculative interactive map for Light No Fire. Trailer-based biomes, creatures, and POIs. Updated as we learn more.";
const ogImage = "/images/og/lnf-map-og.webp";

// Helpers
function toSeconds(tc?: string) {
  if (!tc) return 0;
  const parts = tc.split(":").map((x) => parseInt(x, 10));
  if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
  if (parts.length === 2) return parts[0] * 60 + parts[1];
  return 0;
}
function secondsFromRef(ref?: string) {
  // expects formats like "Trailer 01:25" or "01:25"
  if (!ref) return 0;
  const m = ref.match(/(\d{1,2}:\d{2})(?::\d{2})?$/);
  return m ? toSeconds(m[1]) : 0;
}
const youtubeId = LNF_MAP.video?.youtubeId;

// Build convenient accessors
const layers = LNF_MAP.layers || [];
const biomesLayer = layers.find((l) => l.id === "biomes");
const otherLayers = layers.filter((l) => l.id !== "biomes");

// For SEO ItemList (only biomes, as requested focus)
const biomeItemsForLd = (biomesLayer?.markers || []).map((m, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: m.title,
  url: `https://www.lnfguides.com/light-no-fire-map/#${m.id}`
}));
---

<BaseLayout
  title={title}
  description={description}
  canonical={"https://www.lnfguides.com/light-no-fire-map/"}
  ogImage={ogImage}
  type="website"
  imageAlt="Light No Fire pre-release interactive map with markers"
  article={{
    published: LNF_MAP.lastUpdatedISO,
    modified: LNF_MAP.lastUpdatedISO,
    author: "LNF Guides",
    section: "Tools",
    tags: ["Light No Fire", "Interactive Map", "Biomes", "Trailer analysis"]
  }}
>
  <main class="mx-auto max-w-6xl container-px py-10">
    <!-- Hero -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
        Light No Fire Interactive Map <span class="text-text2 text-xl">(Pre-Release)</span>
      </h1>
      <div class="mt-2 flex flex-wrap items-center gap-3 text-sm text-text2">
        <span class="inline-flex items-center gap-2 rounded-full border border-border/60 px-3 py-1">
          Speculative
        </span>
        <span>Updated {updated}</span>
      </div>
      {LNF_MAP.disclaimerHtml && (
        <p class="mt-3 text-sm text-text2" set:html={LNF_MAP.disclaimerHtml} />
      )}
    </header>

    <!-- Interactive Map -->
    <section class="mb-12">
      <LNFMap client:load config={LNF_MAP} />
      <p class="mt-2 text-xs text-text2">
        Tip: Hover markers to preview; click to open gallery. Use filters above the map to narrow by tags and confidence.
      </p>
    </section>

    <!-- Table of Contents / Linkability -->
    <nav class="card p-4 md:p-5 mb-12" aria-label="Table of contents">
      <h2 class="text-lg font-semibold mb-3">In this article</h2>
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-y-2 gap-x-6 text-sm">
        {biomesLayer?.markers.map((m) => (
          <a href={`#${m.id}`} class="underline decoration-transparent hover:decoration-accent lc-1">
            {m.title}
          </a>
        ))}
      </div>
    </nav>

    <!-- Article body -->
    <section class="prose">
      <h2 id="overview">Everything we know so far</h2>
      <p>
        <strong>Light No Fire</strong> is described as adventure, building, survival and exploration on a
        <em> procedural, Earth-scale fantasy planet</em>, with multiplayer and persistent building. There won’t be a single, fixed minimap.
        This pre-release tool visualizes <em>what we can infer from public material</em> (mainly the first trailer) — biomes, structures,
        creatures and points of interest — and will be updated as new information emerges.
      </p>
      <p>
        Looking for more details? Try our
        <a href="/what-is-light-no-fire/">introductory guide</a>,
        <a href="/trailer-breakdown-what-does-the-first-light-no-fire-trailer-reveal/">trailer breakdown</a>,
        and <a href="/light-no-fire-platforms/">platforms overview</a>.
      </p>

      <h3>How to read this map</h3>
      <ul>
        <li><strong>Markers</strong> are placed illustratively on a speculative base world image.</li>
        <li><strong>Confidence</strong> from 0.2 to 1.0 shows how certain a marker is.</li>
        <li><strong>Sources</strong> link to the exact <em>trailer timestamp</em> we used (when available).</li>
      </ul>
    </section>

    <!-- BIOMES SECTION (rich content mirroring the map) -->
    {biomesLayer && (
      <section class="prose mt-12">
        <h2 id="biomes">Biomes spotted in trailer</h2>
        <p>
          Below is a written overview of all <strong>biomes</strong> we identified in the first Light No Fire trailer.
          These mirror the markers on the interactive map above — complete with notes, screenshots and source timestamps.
        </p>

        {biomesLayer.markers.map((biome) => {
          const firstMedia = biome.media?.[0];
          const mediaTs = firstMedia?.timecode ? toSeconds(firstMedia.timecode) : 0;
          const sourceTs = biome.sources?.length ? secondsFromRef(biome.sources[0].ref) : 0;
          const deepTs = mediaTs || sourceTs;
          const ytHref = youtubeId && deepTs ? `https://www.youtube.com/watch?v=${youtubeId}&t=${deepTs}s` : null;

          return (
            <article id={biome.id} class="mt-10 border-b border-border/40 pb-8">
              <div class="flex items-start justify-between gap-4">
                <h3 class="text-xl font-bold lc-2">{biome.title}</h3>

                <!-- Copy link button -->
                <button
                  class="btn btn-outline text-xs shrink-0"
                  data-copy-anchor={biome.id}
                  type="button"
                  aria-label={`Copy link to ${biome.title}`}
                >
                  Copy link
                </button>
              </div>

              <!-- Thumbnail + meta -->
              <div class="grid md:grid-cols-4 gap-4 mt-3">
                <div class="md:col-span-3 space-y-2">
                  <p>{biome.notes}</p>

                  <p class="text-sm text-text2">
                    Confidence: <span class="font-semibold">{Math.round(biome.confidence * 100)}%</span>
                  </p>

                  {biome.tags && (
                    <p class="text-sm">
                      {biome.tags.map((tag) => (
                        <span
                          class="inline-block bg-surface border border-border/60 rounded-full px-2 py-0.5 text-xs mr-1 mb-1"
                          >{tag}</span
                        >
                      ))}
                    </p>
                  )}

                  {(biome.sources?.length || ytHref) && (
                    <p class="text-sm text-text2">
                      Sources:&nbsp;
                      {ytHref ? (
                        <a href={ytHref} target="_blank" rel="noopener" class="underline">
                          {biome.sources?.[0]?.ref ?? "Trailer timestamp"}
                        </a>
                      ) : (
                        biome.sources?.map((s, i) => (
                          <span>
                            {i > 0 ? ", " : ""}
                            {s.ref}
                          </span>
                        ))
                      )}
                    </p>
                  )}
                </div>
              </div>

              <!-- Media gallery -->
              {biome.media && biome.media.length > 0 && (
                <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                  {biome.media.map((m) => (
                    <a href={m.fullUrl} target="_blank" rel="noopener" class="block group">
                      <img
                        src={m.thumbUrl}
                        alt={m.caption}
                        loading="lazy"
                        class="rounded shadow-soft group-hover:opacity-90"
                      />
                      <p class="text-xs text-text2 mt-1">{m.caption}{m.timecode ? ` (${m.timecode})` : ""}</p>
                    </a>
                  ))}
                </div>
              )}

              <!-- Back to top -->
              <div class="mt-4">
                <a href="#overview" class="text-sm underline decoration-transparent hover:decoration-accent">Back to top</a>
              </div>
            </article>
          );
        })}
      </section>
    )}

    <!-- OPTIONAL: OTHER LAYERS (if populated later) -->
    {otherLayers.length > 0 && (
      <section class="prose mt-12">
        {otherLayers.map((layer) => (
          <>
            {layer.markers.length > 0 && (
              <>
                <h2 id={layer.id}>{layer.title}</h2>
                {layer.markers.map((m) => {
                  const fm = m.media?.[0];
                  const mTs = fm?.timecode ? toSeconds(fm.timecode) : 0;
                  const sTs = m.sources?.length ? secondsFromRef(m.sources[0].ref) : 0;
                  const deepts = mTs || sTs;
                  const href = youtubeId && deepts ? `https://www.youtube.com/watch?v=${youtubeId}&t=${deepts}s` : null;

                  return (
                    <article id={m.id} class="mt-10 border-b border-border/40 pb-8">
                      <div class="flex items-start justify-between gap-4">
                        <h3 class="text-xl font-bold lc-2">{m.title}</h3>
                        <button
                          class="btn btn-outline text-xs shrink-0"
                          data-copy-anchor={m.id}
                          type="button"
                          aria-label={`Copy link to ${m.title}`}
                        >
                          Copy link
                        </button>
                      </div>

                      <div class="grid md:grid-cols-4 gap-4 mt-3">
                        <div class="md:col-span-1">
                          <img src={m.thumbUrl} alt={m.title} class="rounded shadow-soft" loading="lazy" />
                        </div>
                        <div class="md:col-span-3 space-y-2">
                          {m.notes && <p>{m.notes}</p>}
                          <p class="text-sm text-text2">
                            Confidence: <span class="font-semibold">{Math.round(m.confidence * 100)}%</span>
                          </p>
                          {m.tags && (
                            <p class="text-sm">
                              {m.tags.map((t) => (
                                <span class="inline-block bg-surface border border-border/60 rounded-full px-2 py-0.5 text-xs mr-1 mb-1">{t}</span>
                              ))}
                            </p>
                          )}
                          {(m.sources?.length || href) && (
                            <p class="text-sm text-text2">
                              Sources:&nbsp;
                              {href ? (
                                <a href={href} target="_blank" rel="noopener" class="underline">
                                  {m.sources?.[0]?.ref ?? "Trailer timestamp"}
                                </a>
                              ) : (
                                m.sources?.map((s, i) => <span>{i > 0 ? ", " : ""}{s.ref}</span>)
                              )}
                            </p>
                          )}
                        </div>
                      </div>

                      {m.media && m.media.length > 0 && (
                        <div class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                          {m.media.map((mi) => (
                            <a href={mi.fullUrl} target="_blank" rel="noopener" class="block group">
                              <img src={mi.thumbUrl} alt={mi.caption} loading="lazy" class="rounded shadow-soft group-hover:opacity-90" />
                              <p class="text-xs text-text2 mt-1">{mi.caption}{mi.timecode ? ` (${mi.timecode})` : ""}</p>
                            </a>
                          ))}
                        </div>
                      )}

                      <div class="mt-4">
                        <a href="#overview" class="text-sm underline decoration-transparent hover:decoration-accent">Back to top</a>
                      </div>
                    </article>
                  );
                })}
              </>
            )}
          </>
        ))}
      </section>
    )}

    <!-- Changelog -->
    <section class="prose mt-14">
      <h2>Changelog</h2>
      <ul>
        <li>{updated}: Added/updated biome markers and screenshots based on trailer review.</li>
        <li>Sep 15, 2025: Initial pre-release map published.</li>
      </ul>
    </section>
  </main>

  <!-- Copy-link script (client only) -->
  <script is:inline>
    (function(){
      function notify(el, msg){
        try {
          const old = el.textContent;
          el.textContent = msg;
          el.disabled = true;
          setTimeout(() => { el.textContent = "Copy link"; el.disabled = false; }, 1200);
        } catch {}
      }
      document.addEventListener('click', function(ev){
        const btn = ev.target && ev.target.closest && ev.target.closest('[data-copy-anchor]');
        if (!btn) return;
        ev.preventDefault();
        const id = btn.getAttribute('data-copy-anchor');
        if (!id) return;
        const url = location.origin + location.pathname + '#' + id;
        try {
          navigator.clipboard.writeText(url).then(() => notify(btn, 'Copied!')).catch(() => notify(btn, 'Copied!'));
        } catch {
          try { prompt('Copy link:', url); } catch {}
        }
      }, { passive: false });
    })();
  </script>

  <!-- Structured Data: WebPage + ItemList (Biomes) + FAQ -->
  <script type="application/ld+json" is:inline>
    {JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebPage",
      "name": "Light No Fire Interactive Map (Pre-Release)",
      "url": "https://www.lnfguides.com/light-no-fire-map/",
      "dateModified": LNF_MAP.lastUpdatedISO,
      "description": "Speculative interactive map for Light No Fire. Trailer-based biomes, creatures, and POIs. Updated as we learn more."
    })}
  </script>
  {biomeItemsForLd.length > 0 && (
    <script type="application/ld+json" is:inline>
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "ItemList",
        "name": "Light No Fire Biomes (Trailer Analysis)",
        "itemListElement": biomeItemsForLd
      })}
    </script>
  )}
  <script type="application/ld+json" is:inline>
    {JSON.stringify({
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "Is this the official Light No Fire map?",
          "acceptedAnswer": { "@type": "Answer", "text": "No. This is a speculative, pre-release map based on trailer analysis and public information. It will be updated as new details emerge." }
        },
        {
          "@type": "Question",
          "name": "Will Light No Fire have a fixed map?",
          "acceptedAnswer": { "@type": "Answer", "text": "The game is described as procedural and Earth-scale. Expect highly variable worlds; this tool visualizes known elements for discovery and discussion." }
        },
        {
          "@type": "Question",
          "name": "Where do the screenshots come from?",
          "acceptedAnswer": { "@type": "Answer", "text": "Screenshots are taken from publicly available trailers solely for commentary, analysis and education (fair use). We link to the original timestamps where possible." }
        }
      ]
    })}
  </script>
</BaseLayout>
