---
import BaseLayout from "../../layouts/BaseLayout.astro";
const title = "Privacy & Cookies";
const description = "Manage your privacy choices for analytics, embeds and ads on LNF Guides.";
const canonical = new URL('/privacy/', Astro.site!);
---

<BaseLayout {title} {description} {canonical}>
  <div class="mx-auto max-w-3xl px-4 py-12">
    <h1 class="text-3xl font-extrabold tracking-tight mb-3">Privacy & Cookies</h1>
    <p class="text-text2 mb-6">
      Here you can review what we use and change your preferences at any time. Your choices are stored locally in your browser.
    </p>

    <section class="card p-4 md:p-5 mb-6">
      <h2 class="text-xl font-semibold mb-2">Your current choices</h2>
      <ul class="space-y-2 text-sm">
        <li class="flex justify-between">
          <span>Analytics</span>
          <strong id="st-analytics" class="text-text">–</strong>
        </li>
        <li class="flex justify-between">
          <span>External embeds (YouTube, Giscus, …)</span>
          <strong id="st-external" class="text-text">–</strong>
        </li>
        <li class="flex justify-between">
          <span>Ads (non-personalized)</span>
          <strong id="st-ads" class="text-text">–</strong>
        </li>
      </ul>

      <div class="mt-4 flex gap-3">
        <button class="btn btn-primary" data-privacy-open>Open privacy settings</button>
        <button id="btn-reset" class="btn btn-outline">Reset consent</button>
      </div>
    </section>

    <section class="prose max-w-none">
      <h2>What we use</h2>
      <ul>
        <li><strong>Essential</strong>: required for core functionality (no consent needed).</li>
        <li><strong>Analytics</strong>: Plausible (EU-hosted). Loaded only with your consent.</li>
        <li><strong>External embeds</strong>: YouTube (nocookie) &amp; Giscus (GitHub Discussions). Loaded only with your consent.</li>
        <li><strong>Ads</strong>: Slots render only with your consent. By default we request <em>non-personalized</em> ads.</li>
      </ul>

      <h2>Right to withdraw &amp; renewals</h2>
      <p>
        You can withdraw or change your consent at any time via the button above. We may ask you to renew consent if our policy changes.
      </p>

      <h2>Contact</h2>
      <p>
        For questions regarding privacy, please use our <a href="/contact/">contact</a> page.
      </p>
    </section>
  </div>

  <script>
    (function(){
      const LS_KEYS = ['lnf-consent-v1','lnf-consent'];
      function read() {
        try {
          const via = window.consent?.get?.();
          if (via && (via.analytics !== undefined)) return via;
          if (via?.decisions) return via.decisions;
        } catch {}
        for (const k of LS_KEYS) {
          try {
            const raw = localStorage.getItem(k);
            if (raw) {
              const p = JSON.parse(raw);
              return p?.decisions || { analytics:false, external:false, ads:false };
            }
          } catch {}
        }
        return { analytics:false, external:false, ads:false };
      }
      function paint(){
        const d = read();
        const yn = (v) => v ? 'Allowed' : 'Blocked';
        document.getElementById('st-analytics')!.textContent = yn(!!d.analytics);
        document.getElementById('st-external')!.textContent  = yn(!!d.external);
        document.getElementById('st-ads')!.textContent       = yn(!!d.ads);
      }
      paint();
      window.addEventListener('consent:changed', paint);
      window.addEventListener('consent:updated', paint);

      document.getElementById('btn-reset')?.addEventListener('click', (e) => {
        e.preventDefault();
        try {
          // harte Löschung beider möglichen Keys
          localStorage.removeItem('lnf-consent-v1');
          localStorage.removeItem('lnf-consent');
          // neutrales Event, damit UI/Embeds reagieren
          window.dispatchEvent(new CustomEvent('consent:changed', { detail: { analytics:false, external:false, ads:false }}));
        } catch {}
        // und direkt die Settings öffnen, damit man neu wählen kann
        if (window?.consentUI?.open) window.consentUI.open('settings');
        setTimeout(paint, 50);
      });
    })();
  </script>
</BaseLayout>
